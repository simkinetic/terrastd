name: ci-docker-amd64

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Pull Docker image
        run: docker pull ghcr.io/simkinetic/terra-amd64:latest
      - name: Run tests
        id: run-tests
        run: |
          # Run tests, capture output and exit code
          OUTPUT=$(docker run --rm -v $PWD:/app -w /app -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} ghcr.io/simkinetic/terra-amd64:latest bash -c "git config --global url.\"https://oauth2:\$GITHUB_TOKEN@github.com/\".insteadOf \"git@github.com:\" && cosm activate && . /app/.cosm/.env && terra test/testrunner.t --test" 2>&1 || echo "Execution failed with exit code $?" >&2)
          EXIT_CODE=$?

          # Save output to temporary file for parsing
          echo "$OUTPUT" > test_output.txt
          
          # Extract total tests passed and failed
          PASSED=$(grep -oP 'Total Tests Passed: \K\d+' test_output.txt || echo "0")
          echo "Total Tests Passed: $PASSED"
          echo "TESTS_PASSED=$PASSED" >> $GITHUB_ENV
          
          FAILED=$(grep -oP 'Total Tests Failed: \K\d+' test_output.txt || echo "0")
          echo "Total Tests Failed: $FAILED"
          echo "TESTS_FAILED=$FAILED" >> $GITHUB_ENV
          
          # Store exit code for next step
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV
      - name: Check test results
        run: |
          # Print test output
          echo "Test Output (Check Step):"
          cat test_output.txt
          
          # Fail if exit code is non-zero or tests failed
          if [ "${{ env.EXIT_CODE }}" -ne 0 ] || [ "${{ env.TESTS_FAILED }}" -gt 0 ]; then
            echo "Test failures or execution errors detected"
            exit 1
          fi
      - name: Summarize test results
        run: |
          echo "Test Summary:"
          echo "Total Tests Passed: ${{ env.TESTS_PASSED }}"
          echo "Total Tests Failed: ${{ env.TESTS_FAILED }}"
          echo "Exit Code: ${{ env.EXIT_CODE }}"
        if: always()